name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: order-processing-text-rg
  REGISTRY_NAME: orderprocessingtextregistry
  REGISTRY_LOGIN_SERVER: orderprocessingtextregistry.azurecr.io
  FRONTEND_APP_NAME: order-processing-text-frontend
  BACKEND_APP_NAME: order-processing-text-backend
  WORKER_APP_NAME: order-processing-text-worker
  ENVIRONMENT_NAME: order-processing-text-env

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.REGISTRY_NAME }}

      - name: Build and Push Frontend Image
        run: |
          cd frontend
          docker build --no-cache -t ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:${{ github.sha }} \
                       -t ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:latest \
                       --build-arg VITE_AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }} \
                       --build-arg VITE_AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }} \
                       --build-arg VITE_API_URL=${{ secrets.VITE_API_URL }} .
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:${{ github.sha }}
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:latest

      - name: Build and Push Backend Image
        run: |
          docker build -t ${{ env.REGISTRY_LOGIN_SERVER }}/backend:${{ github.sha }} \
                       -t ${{ env.REGISTRY_LOGIN_SERVER }}/backend:latest \
                       -f backend/Dockerfile .
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/backend:${{ github.sha }}
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/backend:latest

      - name: Build and Push Celery Worker Image
        run: |
          docker build -t ${{ env.REGISTRY_LOGIN_SERVER }}/worker:${{ github.sha }} \
                       -t ${{ env.REGISTRY_LOGIN_SERVER }}/worker:latest \
                       -f Dockerfile.worker .
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/worker:${{ github.sha }}
          docker push ${{ env.REGISTRY_LOGIN_SERVER }}/worker:latest

      - name: Deploy Frontend Container App
        run: |
          az containerapp create \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.ENVIRONMENT_NAME }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:${{ github.sha }} \
            --target-port 80 \
            --ingress external \
            --cpu 0.25 --memory 0.5Gi \
            --min-replicas 1 --max-replicas 3 \
            --registry-server ${{ env.REGISTRY_LOGIN_SERVER }} || \
          az containerapp update \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:${{ github.sha }}

      - name: Deploy Backend Container App
        run: |
          az containerapp create \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.ENVIRONMENT_NAME }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/backend:${{ github.sha }} \
            --target-port 8000 \
            --ingress external \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 5 \
            --registry-server ${{ env.REGISTRY_LOGIN_SERVER }} \
            --secrets \
              database-url="${{ secrets.DATABASE_URL }}" \
              anthropic-api-key="${{ secrets.ANTHROPIC_API_KEY }}" \
              microsoft-tenant-id="${{ secrets.MICROSOFT_TENANT_ID }}" \
              microsoft-client-id="${{ secrets.MICROSOFT_CLIENT_ID }}" \
              microsoft-client-secret="${{ secrets.MICROSOFT_CLIENT_SECRET }}" \
              microsoft-object-id="${{ secrets.MICROSOFT_OBJECT_ID }}" \
              redis-url="${{ secrets.AZURE_REDIS_URL }}" \
              storage-connection-string="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              jwt-secret="${{ secrets.JWT_SECRET }}" \
              azure-storage-key="${{ secrets.AZURE_STORAGE_KEY }}" \
            --env-vars \
              DATABASE_URL=secretref:database-url \
              ANTHROPIC_API_KEY=secretref:anthropic-api-key \
              MICROSOFT_TENANT_ID=secretref:microsoft-tenant-id \
              MICROSOFT_CLIENT_ID=secretref:microsoft-client-id \
              MICROSOFT_CLIENT_SECRET=secretref:microsoft-client-secret \
              MICROSOFT_OBJECT_ID=secretref:microsoft-object-id \
              REDIS_URL=secretref:redis-url \
              AZURE_STORAGE_CONNECTION_STRING=secretref:storage-connection-string \
              JWT_SECRET=secretref:jwt-secret \
              AZURE_STORAGE_KEY=secretref:azure-storage-key \
              AZURE_STORAGE_ACCOUNT="${{ vars.AZURE_STORAGE_ACCOUNT }}" \
              AZURE_FILE_SHARE="${{ vars.AZURE_FILE_SHARE }}" \
              FRONTEND_URL="${{ secrets.FRONTEND_URL }}" || \
          az containerapp update \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/backend:${{ github.sha }} \
            --set-env-vars \
              DATABASE_URL=secretref:database-url \
              ANTHROPIC_API_KEY=secretref:anthropic-api-key \
              MICROSOFT_TENANT_ID=secretref:microsoft-tenant-id \
              MICROSOFT_CLIENT_ID=secretref:microsoft-client-id \
              MICROSOFT_CLIENT_SECRET=secretref:microsoft-client-secret \
              MICROSOFT_OBJECT_ID=secretref:microsoft-object-id \
              REDIS_URL=secretref:redis-url \
              AZURE_STORAGE_CONNECTION_STRING=secretref:storage-connection-string \
              JWT_SECRET=secretref:jwt-secret \
              AZURE_STORAGE_KEY=secretref:azure-storage-key \
              AZURE_STORAGE_ACCOUNT="${{ vars.AZURE_STORAGE_ACCOUNT }}" \
              AZURE_FILE_SHARE="${{ vars.AZURE_FILE_SHARE }}" \
              FRONTEND_URL="${{ secrets.FRONTEND_URL }}"

      - name: Deploy Celery Worker Container App
        run: |
          az containerapp create \
            --name ${{ env.WORKER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.ENVIRONMENT_NAME }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/worker:${{ github.sha }} \
            --cpu 0.5 --memory 1.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --registry-server ${{ env.REGISTRY_LOGIN_SERVER }} \
            --secrets \
              database-url="${{ secrets.DATABASE_URL }}" \
              anthropic-api-key="${{ secrets.ANTHROPIC_API_KEY }}" \
              microsoft-tenant-id="${{ secrets.MICROSOFT_TENANT_ID }}" \
              microsoft-client-id="${{ secrets.MICROSOFT_CLIENT_ID }}" \
              microsoft-client-secret="${{ secrets.MICROSOFT_CLIENT_SECRET }}" \
              microsoft-object-id="${{ secrets.MICROSOFT_OBJECT_ID }}" \
              redis-url="${{ secrets.AZURE_REDIS_URL }}" \
              storage-connection-string="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              jwt-secret="${{ secrets.JWT_SECRET }}" \
              azure-storage-key="${{ secrets.AZURE_STORAGE_KEY }}" \
            --env-vars \
              DATABASE_URL=secretref:database-url \
              ANTHROPIC_API_KEY=secretref:anthropic-api-key \
              MICROSOFT_TENANT_ID=secretref:microsoft-tenant-id \
              MICROSOFT_CLIENT_ID=secretref:microsoft-client-id \
              MICROSOFT_CLIENT_SECRET=secretref:microsoft-client-secret \
              MICROSOFT_OBJECT_ID=secretref:microsoft-object-id \
              REDIS_URL=secretref:redis-url \
              AZURE_STORAGE_CONNECTION_STRING=secretref:storage-connection-string \
              JWT_SECRET=secretref:jwt-secret \
              AZURE_STORAGE_KEY=secretref:azure-storage-key \
              AZURE_STORAGE_ACCOUNT="${{ vars.AZURE_STORAGE_ACCOUNT }}" \
              AZURE_FILE_SHARE="${{ vars.AZURE_FILE_SHARE }}" || \
          az containerapp update \
            --name ${{ env.WORKER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY_LOGIN_SERVER }}/worker:${{ github.sha }} \
            --set-env-vars \
              DATABASE_URL=secretref:database-url \
              ANTHROPIC_API_KEY=secretref:anthropic-api-key \
              MICROSOFT_TENANT_ID=secretref:microsoft-tenant-id \
              MICROSOFT_CLIENT_ID=secretref:microsoft-client-id \
              MICROSOFT_CLIENT_SECRET=secretref:microsoft-client-secret \
              MICROSOFT_OBJECT_ID=secretref:microsoft-object-id \
              REDIS_URL=secretref:redis-url \
              AZURE_STORAGE_CONNECTION_STRING=secretref:storage-connection-string \
              JWT_SECRET=secretref:jwt-secret \
              AZURE_STORAGE_KEY=secretref:azure-storage-key \
              AZURE_STORAGE_ACCOUNT="${{ vars.AZURE_STORAGE_ACCOUNT }}" \
              AZURE_FILE_SHARE="${{ vars.AZURE_FILE_SHARE }}"

      - name: Health Check - Backend
        run: |
          BACKEND_URL=$(az containerapp show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "Backend URL: https://$BACKEND_URL"

          # Wait 30 seconds for deployment to stabilize
          sleep 30

          # Health check with retries
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/api/health)
            if [ "$HTTP_CODE" == "200" ]; then
              echo "Backend health check passed"
              exit 0
            fi
            echo "Attempt $i: Health check returned $HTTP_CODE, retrying in 10s..."
            sleep 10
          done

          echo "Backend health check failed after 5 attempts"
          exit 1

      - name: Health Check - Frontend
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "Frontend URL: https://$FRONTEND_URL"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$FRONTEND_URL/health)
          if [ "$HTTP_CODE" == "200" ]; then
            echo "Frontend health check passed"
          else
            echo "Frontend health check failed with code $HTTP_CODE"
            exit 1
          fi

      - name: Display Application URLs
        run: |
          echo "Deployment Complete!"
          echo ""
          echo "Frontend URL:"
          az containerapp show \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv
          echo ""
          echo "Backend URL:"
          az containerapp show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv
